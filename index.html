<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å½ˆè—¥äº¤æ˜“ç³»çµ± ULTRA v2</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background:#0d1117; color:#e6edf3; padding:20px; }
h1 { color:#58a6ff; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #30363d; padding:6px; text-align:center; }
th { background:#161b22; }
input, select { width:90px; padding:4px; background:#0d1117; color:white; border:1px solid #30363d; }
button { padding:4px 8px; margin:2px; cursor:pointer; border:none; color:white; }
.sellBtn { background:#da3633; }
.editBtn { background:#8957e5; }
.saveBtn { background:#238636; }
.loss { color:#ff6b6b; font-weight:bold; }
.profit { color:#3fb950; font-weight:bold; }
.summary { margin-top:20px; font-size:18px; }
.section { margin-top:30px; }
canvas { background:#111; margin-top:20px; }
</style>
</head>
<body>

<h1>ğŸ“ˆ å½ˆè—¥äº¤æ˜“ç³»çµ± ULTRA v2</h1>

äº¤æ˜“ç¨…ç‡: <input type="number" id="taxRate" value="10">

<div class="section">
<h2>â• è²·é€²</h2>
<select id="ammoSelect">
  <option>7.62x39 BP</option>
  <option>7.62x39 AP</option>
  <option>5.45x39 BS</option>
  <option>5.8x42 DBP10</option>
  <option>5.8x42 è—å½ˆ</option>
  <option>6.8x51 Hybrid</option>
  <option>.300 Blackout</option>
  <option>9x19 RIP</option>
</select>
è²·é€²å–®åƒ¹ï¼š<input type="number" id="buyPrice">
æ•¸é‡ï¼š<input type="number" id="buyQty">
<button class="saveBtn" onclick="addBuy()">è²·é€²</button>
</div>

<div class="section">
<h2>ğŸ“¦ æŒå€‰ç¸½è¦½</h2>
<table id="portfolio">
<thead>
<tr>
<th>å­å½ˆ</th><th>æ•¸é‡</th><th>å¹³å‡æˆæœ¬</th>
<th>ç¾åƒ¹</th><th>å¸‚å€¼</th><th>æœªå¯¦ç¾æç›Š</th><th>å ±é…¬ç‡</th><th>è³£å‡º</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="summary">
ç¸½å¸‚å€¼ï¼š<span id="totalValue">0</span>ã€€
æœªå¯¦ç¾æç›Šï¼š<span id="totalUnrealized">0</span>ã€€
å·²å¯¦ç¾æç›Šï¼š<span id="realizedPnL">0</span>
</div>

<div class="section">
<h2>ğŸ§¾ å”®å‡ºæ­·å²ï¼ˆå¯ç›´æ¥ä¿®æ”¹ï¼‰</h2>
<table id="sellHistory">
<thead>
<tr>
<th>æ™‚é–“</th><th>å­å½ˆ</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å¯¦ç¾æç›Š</th><th>æ“ä½œ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
let portfolio = JSON.parse(localStorage.getItem("ammoPortfolio")||"{}");
let sellHistory = JSON.parse(localStorage.getItem("sellHistory")||"[]");

function saveAll(){
    localStorage.setItem("ammoPortfolio",JSON.stringify(portfolio));
    localStorage.setItem("sellHistory",JSON.stringify(sellHistory));
}

function recalcRealized(){
    let total = 0;
    sellHistory.forEach(r => total += r.pnl);
    document.getElementById("realizedPnL").innerText = total.toFixed(0);
}

function addBuy(){
    const name = ammoSelect.value;
    const price = parseFloat(buyPrice.value)||0;
    const qty = parseFloat(buyQty.value)||0;
    if(!portfolio[name]) portfolio[name]={qty:0, cost:0, price:0};
    portfolio[name].cost += price*qty;
    portfolio[name].qty += qty;
    saveAll(); render();
}

function sellAmmo(name){
    const qty = parseFloat(prompt("è³£å‡ºæ•¸é‡ï¼š"))||0;
    const sellPrice = parseFloat(prompt("è³£å‡ºå–®åƒ¹ï¼š"))||0;
    const tax = taxRate.value/100;
    const p = portfolio[name];
    if(qty<=0 || qty>p.qty) return alert("æ•¸é‡éŒ¯èª¤");

    const avgCost = p.cost/p.qty;
    const revenue = sellPrice*qty*(1-tax);
    const cost = avgCost*qty;
    const pnl = revenue - cost;

    p.qty -= qty;
    p.cost -= cost;
    if(p.qty<=0) delete portfolio[name];

    sellHistory.push({
        time:new Date().toLocaleString(),
        name, qty, sellPrice, avgCost, pnl
    });

    saveAll(); render();
}

function render(){
    const tbody=document.querySelector("#portfolio tbody");
    const historyBody=document.querySelector("#sellHistory tbody");
    tbody.innerHTML=""; historyBody.innerHTML="";
    const tax = taxRate.value/100;
    let totalValue=0,totalUnrealized=0;

    for(const name in portfolio){
        const p=portfolio[name];
        const avg=p.cost/p.qty;
        const value=p.price*p.qty*(1-tax);
        const pnl=value-p.cost;
        const roi=(pnl/p.cost)*100;
        totalValue+=value;
        totalUnrealized+=pnl;

        tbody.innerHTML+=`
        <tr>
          <td>${name}</td>
          <td>${p.qty}</td>
          <td>${avg.toFixed(2)}</td>
          <td><input type="number" value="${p.price||0}" onchange="portfolio['${name}'].price=this.value;saveAll();render()"></td>
          <td>${value.toFixed(0)}</td>
          <td class="${pnl>=0?'profit':'loss'}">${pnl.toFixed(0)}</td>
          <td class="${roi>=0?'profit':'loss'}">${roi.toFixed(1)}%</td>
          <td><button class="sellBtn" onclick="sellAmmo('${name}')">è³£å‡º</button></td>
        </tr>`;
    }

    sellHistory.forEach((r,i)=>{
        historyBody.innerHTML+=`
        <tr>
          <td>${r.time}</td>
          <td>${r.name}</td>
          <td><input type="number" value="${r.qty}" onchange="editRecord(${i}, 'qty', this.value)"></td>
          <td><input type="number" value="${r.sellPrice}" onchange="editRecord(${i}, 'sellPrice', this.value)"></td>
          <td class="${r.pnl>=0?'profit':'loss'}">${r.pnl.toFixed(0)}</td>
          <td><button class="editBtn" onclick="recalcRecord(${i})">é‡ç®—</button></td>
        </tr>`;
    });

    document.getElementById("totalValue").innerText=totalValue.toFixed(0);
    document.getElementById("totalUnrealized").innerText=totalUnrealized.toFixed(0);
    recalcRealized();
}

function editRecord(i, field, val){
    sellHistory[i][field] = parseFloat(val)||0;
}

function recalcRecord(i){
    const r = sellHistory[i];
    const tax = taxRate.value/100;
    const revenue = r.sellPrice*r.qty*(1-tax);
    const cost = r.avgCost*r.qty;
    r.pnl = revenue - cost;
    saveAll(); render();
}

render();
</script>
</body>
</html>