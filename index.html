<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å½ˆè—¥äº¤æ˜“ç³»çµ± ULTRA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background:#0d1117; color:#e6edf3; padding:20px; }
h1 { color:#58a6ff; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #30363d; padding:6px; text-align:center; }
th { background:#161b22; }
input, select { width:100px; padding:4px; background:#0d1117; color:white; border:1px solid #30363d; }
button { padding:5px 10px; margin:3px; cursor:pointer; background:#238636; color:white; border:none; }
.sellBtn { background:#da3633; }
.editBtn { background:#8957e5; }
.loss { color:#ff6b6b; font-weight:bold; }
.profit { color:#3fb950; font-weight:bold; }
.summary { margin-top:20px; font-size:18px; }
canvas { background:#111; margin-top:20px; }
.section { margin-top:30px; }
</style>
</head>
<body>

<h1>ğŸ“ˆ å½ˆè—¥äº¤æ˜“ç³»çµ± ULTRA</h1>

äº¤æ˜“ç¨…ç‡: <input type="number" id="taxRate" value="10"> %

<div class="section">
<h2>â• è²·é€²</h2>
<select id="ammoSelect">
  <option>7.62x39 BP</option>
  <option>7.62x39 AP</option>
  <option>5.45x39 BS</option>
  <option>5.8x42 DBP10</option>
  <option>5.8x42 è—å½ˆ</option>
  <option>6.8x51 Hybrid</option>
  <option>.300 Blackout</option>
  <option>9x19 RIP</option>
</select>
è²·é€²å–®åƒ¹ï¼š<input type="number" id="buyPrice">
æ•¸é‡ï¼š<input type="number" id="buyQty">
<button onclick="addBuy()">è²·é€²</button>
</div>

<div class="section">
<h2>ğŸ“¦ æŒå€‰ç¸½è¦½</h2>
<table id="portfolio">
<thead>
<tr>
<th>å­å½ˆ</th><th>æ•¸é‡</th><th>å¹³å‡æˆæœ¬</th>
<th>ç¾åƒ¹</th><th>å¸‚å€¼</th><th>æœªå¯¦ç¾æç›Š</th><th>å ±é…¬ç‡</th><th>è³£å‡º</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="summary">
ç¸½å¸‚å€¼ï¼š<span id="totalValue">0</span>ã€€
æœªå¯¦ç¾æç›Šï¼š<span id="totalUnrealized">0</span>ã€€
å·²å¯¦ç¾æç›Šï¼š<span id="realizedPnL">0</span>
</div>

<div class="section">
<h2>ğŸ§¾ å”®å‡ºæ­·å²ï¼ˆå¯ä¿®æ”¹ï¼‰</h2>
<table id="sellHistory">
<thead>
<tr>
<th>æ™‚é–“</th><th>å­å½ˆ</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å¯¦ç¾æç›Š</th><th>ä¿®æ”¹</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="section">
<h2>ğŸ“Š åƒ¹æ ¼èµ°å‹¢åœ–</h2>
<select id="chartSelect" onchange="drawChart()"></select>
<canvas id="priceChart" height="100"></canvas>
</div>

<script>
let portfolio = JSON.parse(localStorage.getItem("ammoPortfolio")||"{}");
let realizedPnL = parseFloat(localStorage.getItem("realizedPnL")||"0");
let sellHistory = JSON.parse(localStorage.getItem("sellHistory")||"[]");
let priceHistory = JSON.parse(localStorage.getItem("priceHistory")||"{}");
let chart;

function save(){
    localStorage.setItem("ammoPortfolio",JSON.stringify(portfolio));
    localStorage.setItem("realizedPnL",realizedPnL);
    localStorage.setItem("sellHistory",JSON.stringify(sellHistory));
    localStorage.setItem("priceHistory",JSON.stringify(priceHistory));
}

function addBuy(){
    const name = ammoSelect.value;
    const price = parseFloat(buyPrice.value)||0;
    const qty = parseFloat(buyQty.value)||0;
    if(!portfolio[name]) portfolio[name]={qty:0, cost:0, price:0};
    portfolio[name].cost += price*qty;
    portfolio[name].qty += qty;
    save(); render();
}

function sellAmmo(name){
    const qty = parseFloat(prompt("è³£å‡ºæ•¸é‡ï¼š"))||0;
    const sellPrice = parseFloat(prompt("è³£å‡ºå–®åƒ¹ï¼š"))||0;
    const tax = taxRate.value/100;
    const p = portfolio[name];
    if(qty<=0 || qty>p.qty) return alert("æ•¸é‡éŒ¯èª¤");

    const avgCost = p.cost/p.qty;
    const revenue = sellPrice*qty*(1-tax);
    const cost = avgCost*qty;
    const pnl = revenue - cost;

    realizedPnL += pnl;
    p.qty -= qty;
    p.cost -= cost;
    if(p.qty<=0) delete portfolio[name];

    sellHistory.push({
        time:new Date().toLocaleString(),
        name, qty, sellPrice, pnl
    });

    save(); render();
}

function editSell(index){
    const record = sellHistory[index];
    const newQty = parseFloat(prompt("ä¿®æ”¹æ•¸é‡ï¼š",record.qty));
    const newPrice = parseFloat(prompt("ä¿®æ”¹å–®åƒ¹ï¼š",record.sellPrice));
    if(isNaN(newQty)||isNaN(newPrice)) return;

    realizedPnL -= record.pnl;

    const avgCost = record.pnl < 0 ? 0 : record.sellPrice; // ç²—ç•¥å›æ¨
    const tax = taxRate.value/100;
    const newRevenue = newPrice*newQty*(1-tax);
    const newCost = avgCost*newQty;
    const newPnL = newRevenue - newCost;

    record.qty=newQty;
    record.sellPrice=newPrice;
    record.pnl=newPnL;

    realizedPnL += newPnL;
    save(); render();
}

function updatePrice(name,price){
    price=parseFloat(price)||0;
    portfolio[name].price=price;
    if(!priceHistory[name]) priceHistory[name]=[];
    priceHistory[name].push({time:new Date().toLocaleTimeString(), price});
    save(); render(); drawChart();
}

function render(){
    const tbody=document.querySelector("#portfolio tbody");
    const historyBody=document.querySelector("#sellHistory tbody");
    const chartSelect=document.getElementById("chartSelect");
    tbody.innerHTML=""; historyBody.innerHTML=""; chartSelect.innerHTML="";
    const tax = taxRate.value/100;
    let totalValue=0,totalUnrealized=0;

    for(const name in portfolio){
        const p=portfolio[name];
        const avg=p.cost/p.qty;
        const value=p.price*p.qty*(1-tax);
        const pnl=value-p.cost;
        const roi=(pnl/p.cost)*100;
        totalValue+=value;
        totalUnrealized+=pnl;

        tbody.innerHTML+=`
        <tr>
          <td>${name}</td>
          <td>${p.qty}</td>
          <td>${avg.toFixed(2)}</td>
          <td><input type="number" value="${p.price}" onchange="updatePrice('${name}',this.value)"></td>
          <td>${value.toFixed(0)}</td>
          <td class="${pnl>=0?'profit':'loss'}">${pnl.toFixed(0)}</td>
          <td class="${roi>=0?'profit':'loss'}">${roi.toFixed(1)}%</td>
          <td><button class="sellBtn" onclick="sellAmmo('${name}')">è³£å‡º</button></td>
        </tr>`;

        chartSelect.innerHTML += `<option value="${name}">${name}</option>`;
    }

    sellHistory.forEach((r,i)=>{
        historyBody.innerHTML+=`
        <tr>
          <td>${r.time}</td>
          <td>${r.name}</td>
          <td>${r.qty}</td>
          <td>${r.sellPrice}</td>
          <td class="${r.pnl>=0?'profit':'loss'}">${r.pnl.toFixed(0)}</td>
          <td><button class="editBtn" onclick="editSell(${i})">ä¿®æ”¹</button></td>
        </tr>`;
    });

    totalValueSpan.innerText=totalValue.toFixed(0);
    totalUnrealizedSpan.innerText=totalUnrealized.toFixed(0);
    realizedSpan.innerText=realizedPnL.toFixed(0);
}

function drawChart(){
    const name = chartSelect.value;
    if(!priceHistory[name]) return;
    const labels = priceHistory[name].map(p=>p.time);
    const data = priceHistory[name].map(p=>p.price);
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("priceChart"), {
        type:'line',
        data:{labels,datasets:[{label:name+" åƒ¹æ ¼èµ°å‹¢",data,borderColor:'#58a6ff',fill:false}]}
    });
}

const totalValueSpan=document.getElementById("totalValue");
const totalUnrealizedSpan=document.getElementById("totalUnrealized");
const realizedSpan=document.getElementById("realizedPnL");

render();
</script>
</body>
</html>