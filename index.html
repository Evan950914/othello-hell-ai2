<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å½ˆè—¥äº¤æ˜“ç³»çµ± FINAL</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background:#0d1117; color:#e6edf3; padding:20px; }
h1 { color:#58a6ff; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #30363d; padding:6px; text-align:center; }
th { background:#161b22; }
input, select { width:90px; padding:4px; background:#0d1117; color:white; border:1px solid #30363d; }
button { padding:4px 8px; margin:2px; cursor:pointer; border:none; color:white; }
.sellBtn { background:#da3633; }
.editBtn { background:#8957e5; }
.saveBtn { background:#238636; }
.loss { color:#ff6b6b; font-weight:bold; }
.profit { color:#3fb950; font-weight:bold; }
.section { margin-top:30px; }
canvas { background:#111; margin-top:20px; }
</style>
</head>
<body>

<h1>ğŸ“ˆ å½ˆè—¥äº¤æ˜“ç³»çµ± FINAL</h1>

äº¤æ˜“ç¨…ç‡: <input type="number" id="taxRate" value="10">
ç›®æ¨™åˆ©æ½¤ç‡%: <input type="number" id="targetProfit" value="15">

<div class="section">
<h2>â• è²·é€²</h2>
<select id="ammoSelect">
  <option>7.62x39 BP</option>
  <option>7.62x39 AP</option>
  <option>5.45x39 BS</option>
  <option>5.8x42 DBP10</option>
  <option>5.8x42 è—å½ˆ</option>
  <option>6.8x51 Hybrid</option>
  <option>.300 Blackout</option>
  <option>9x19 RIP</option>
</select>
è²·é€²å–®åƒ¹ï¼š<input type="number" id="buyPrice">
æ•¸é‡ï¼š<input type="number" id="buyQty">
<button class="saveBtn" onclick="addBuy()">è²·é€²</button>
</div>

<div class="section">
<h2>ğŸ“¦ æŒå€‰ç¸½è¦½</h2>
<table id="portfolio"><thead>
<tr>
<th>å­å½ˆ</th><th>æ•¸é‡</th><th>å¹³å‡æˆæœ¬</th>
<th>ç¾åƒ¹</th><th>å»ºè­°è³£åƒ¹</th>
<th>æœªå¯¦ç¾æç›Š</th><th>å ±é…¬ç‡</th><th>è³£å‡º</th>
</tr></thead><tbody></tbody></table>
</div>

<div class="section">
<h2>ğŸ† åˆ©æ½¤æ’è¡Œæ¦œ</h2>
<table id="ranking"><thead>
<tr><th>æ’å</th><th>å­å½ˆ</th><th>æœªå¯¦ç¾åˆ©æ½¤</th></tr>
</thead><tbody></tbody></table>
</div>

<div class="section">
<h2>ğŸ§¾ å”®å‡ºæ­·å²</h2>
<table id="sellHistory"><thead>
<tr><th>æ™‚é–“</th><th>å­å½ˆ</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>æç›Š</th><th>é‡ç®—</th></tr>
</thead><tbody></tbody></table>
</div>

<div class="section">
<h2>ğŸ“Š åƒ¹æ ¼èµ°å‹¢åœ–</h2>
<select id="chartSelect" onchange="drawChart()"></select>
<canvas id="priceChart" height="100"></canvas>
</div>

<script>
let portfolio = JSON.parse(localStorage.getItem("ammoPortfolio")||"{}");
let sellHistory = JSON.parse(localStorage.getItem("sellHistory")||"[]");
let priceHistory = JSON.parse(localStorage.getItem("priceHistory")||"{}");
let chart;

function saveAll(){
 localStorage.setItem("ammoPortfolio",JSON.stringify(portfolio));
 localStorage.setItem("sellHistory",JSON.stringify(sellHistory));
 localStorage.setItem("priceHistory",JSON.stringify(priceHistory));
}

function addBuy(){
 const name=ammoSelect.value, price=+buyPrice.value||0, qty=+buyQty.value||0;
 if(!portfolio[name]) portfolio[name]={qty:0,cost:0,price:0};
 portfolio[name].cost+=price*qty; portfolio[name].qty+=qty;
 saveAll(); render();
}

function sellAmmo(name){
 const qty=+prompt("è³£å‡ºæ•¸é‡")||0, price=+prompt("è³£å‡ºå–®åƒ¹")||0;
 const tax=taxRate.value/100, p=portfolio[name];
 if(qty<=0||qty>p.qty) return;
 const avg=p.cost/p.qty, pnl=price*qty*(1-tax)-avg*qty;
 p.qty-=qty; p.cost-=avg*qty; if(p.qty<=0) delete portfolio[name];
 sellHistory.push({time:new Date().toLocaleString(),name,qty,price,pnl,avg});
 saveAll(); render();
}

function render(){
 const tbody=portfolioTable(), rankBody=rankingTable(), histBody=sellTable(), chartSel=chartSelect;
 let list=[];
 for(const name in portfolio){
  const p=portfolio[name], avg=p.cost/p.qty, cur=p.price||0;
  const tax=taxRate.value/100, target=targetProfit.value/100;
  const suggest=(avg*(1+target))/(1-tax);
  const pnl=cur*p.qty*(1-tax)-p.cost, roi=pnl/p.cost*100;
  list.push({name,pnl});
  tbody.innerHTML+=`<tr>
   <td>${name}</td><td>${p.qty}</td><td>${avg.toFixed(2)}</td>
   <td><input type=number value="${cur}" onchange="updatePrice('${name}',this.value)"></td>
   <td>${suggest.toFixed(2)}</td>
   <td class="${pnl>=0?'profit':'loss'}">${pnl.toFixed(0)}</td>
   <td class="${roi>=0?'profit':'loss'}">${roi.toFixed(1)}%</td>
   <td><button class=sellBtn onclick="sellAmmo('${name}')">è³£å‡º</button></td>
  </tr>`;
  chartSel.innerHTML+=`<option>${name}</option>`;
 }
 list.sort((a,b)=>b.pnl-a.pnl);
 list.forEach((r,i)=>rankBody.innerHTML+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.pnl.toFixed(0)}</td></tr>`);
 sellHistory.forEach((r,i)=>histBody.innerHTML+=`
 <tr><td>${r.time}</td><td>${r.name}</td>
 <td><input value="${r.qty}" onchange="sellHistory[${i}].qty=this.value"></td>
 <td><input value="${r.price}" onchange="sellHistory[${i}].price=this.value"></td>
 <td class="${r.pnl>=0?'profit':'loss'}">${r.pnl.toFixed(0)}</td>
 <td><button class=editBtn onclick="recalcSell(${i})">é‡ç®—</button></td></tr>`);
}

function updatePrice(name,v){
 v=+v||0; portfolio[name].price=v;
 if(!priceHistory[name]) priceHistory[name]=[];
 priceHistory[name].push({t:new Date().toLocaleTimeString(),p:v});
 saveAll(); render(); drawChart();
}

function recalcSell(i){
 const r=sellHistory[i], tax=taxRate.value/100;
 r.pnl=r.price*r.qty*(1-tax)-r.avg*r.qty;
 saveAll(); render();
}

function drawChart(){
 const name=chartSelect.value;
 if(!priceHistory[name]) return;
 if(chart) chart.destroy();
 chart=new Chart(priceChart,{type:'line',
 data:{labels:priceHistory[name].map(x=>x.t),
 datasets:[{data:priceHistory[name].map(x=>x.p),borderColor:'#58a6ff'}]}});
}

function portfolioTable(){return document.querySelector("#portfolio tbody")}
function rankingTable(){return document.querySelector("#ranking tbody")}
function sellTable(){return document.querySelector("#sellHistory tbody")}

render();
</script>
</body>
</html>